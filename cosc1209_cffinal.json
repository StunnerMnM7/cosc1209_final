{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Deploy ECS Fargate with Networking",
    "Resources": {
      "VPC": {
        "Type": "AWS::EC2::VPC",
        "Properties": {
          "CidrBlock": "10.0.0.0/16",
          "EnableDnsSupport": true,
          "EnableDnsHostnames": true,
          "Tags": [{ "Key": "Name", "Value": "FargateVPC" }]
        }
      },
      "PublicSubnet1": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": { "Ref": "VPC" },
          "CidrBlock": "10.0.1.0/24",
          "MapPublicIpOnLaunch": true,
          "AvailabilityZone": { "Fn::Select": [0, { "Fn::GetAZs": "" }] }
        }
      },
      "PublicSubnet2": {
        "Type": "AWS::EC2::Subnet",
        "Properties": {
          "VpcId": { "Ref": "VPC" },
          "CidrBlock": "10.0.2.0/24",
          "MapPublicIpOnLaunch": true,
          "AvailabilityZone": { "Fn::Select": [1, { "Fn::GetAZs": "" }] }
        }
      },
      "InternetGateway": {
        "Type": "AWS::EC2::InternetGateway"
      },
      "AttachGateway": {
        "Type": "AWS::EC2::VPCGatewayAttachment",
        "Properties": {
          "VpcId": { "Ref": "VPC" },
          "InternetGatewayId": { "Ref": "InternetGateway" }
        }
      },
      "ECSCluster": {
        "Type": "AWS::ECS::Cluster",
        "Properties": {
          "ClusterName": "FargateCluster"
        }
      },
      "ExecutionRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Principal": { "Service": "ecs-tasks.amazonaws.com" },
              "Action": "sts:AssumeRole"
            }]
          },
          "Policies": [{
            "PolicyName": "ECSExecutionPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Action": [
                  "logs:CreateLogStream",
                  "logs:PutLogEvents",
                  "logs:CreateLogGroup"
                ],
                "Resource": "*"
              }]
            }
          }]
        }
      },
      "TaskDefinition": {
        "Type": "AWS::ECS::TaskDefinition",
        "Properties": {
          "Family": "fargate-task",
          "Cpu": "8",
          "Memory": "64",
          "NetworkMode": "awsvpc",
          "RequiresCompatibilities": ["FARGATE"],
          "ExecutionRoleArn": { "Ref": "ExecutionRole" },
          "ContainerDefinitions": [
            {
              "Name": "assign1-server",
              "Image": "043309352934.dkr.ecr.us-east-1.amazonaws.com/cosc1209/final",
              "PortMappings": [{ "ContainerPort": 80, "Protocol": "tcp" }]
            }
          ]
        }
      },
      "FargateService": {
        "Type": "AWS::ECS::Service",
        "Properties": {
          "Cluster": { "Ref": "ECSCluster" },
          "DesiredCount": 1,
          "LaunchType": "FARGATE",
          "TaskDefinition": { "Ref": "TaskDefinition" },
          "NetworkConfiguration": {
            "AwsvpcConfiguration": {
              "Subnets": [{ "Ref": "PublicSubnet1" }, { "Ref": "PublicSubnet2" }],
              "SecurityGroups": [{ "Ref": "SecurityGroup" }],
              "AssignPublicIp": "ENABLED"
            }
          }
        }
      },
      "SecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupDescription": "Allow HTTP traffic",
          "VpcId": { "Ref": "VPC" },
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "CidrIp": "0.0.0.0/0"
            }
          ]
        }
      },
      "LoadBalancer": {
        "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties": {
          "Name": "FargateLB",
          "Subnets": [{ "Ref": "PublicSubnet1" }, { "Ref": "PublicSubnet2" }],
          "SecurityGroups": [{ "Ref": "SecurityGroup" }],
          "Scheme": "internet-facing",
          "Type": "application"
        }
      },
      "Listener": {
        "Type": "AWS::ElasticLoadBalancingV2::Listener",
        "Properties": {
          "LoadBalancerArn": { "Ref": "LoadBalancer" },
          "Protocol": "HTTP",
          "Port": 80,
          "DefaultActions": [{ "Type": "forward", "TargetGroupArn": { "Ref": "TargetGroup" } }]
        }
      },
      "TargetGroup": {
        "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties": {
          "VpcId": { "Ref": "VPC" },
          "Port": 80,
          "Protocol": "HTTP",
          "TargetType": "ip"
        }
      }
    }
  }
  